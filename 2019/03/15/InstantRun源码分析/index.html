<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Android,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="前言Android Studio 从2.0开始就支持了Instant Run ，大大减少了应用编译时长，提升了开发效率。本文将结合Instant Run的源码抛砖引玉，揭开Instant Run 背后的秘密。如有不当之处，烦请不吝赐教。contact me ：bboylin24@gmail.com 本文为作者原创，转载须注明出处。">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="InstantRun原理以及源码分析">
<meta property="og:url" content="https://bboylin.github.io/2019/03/15/InstantRun源码分析/index.html">
<meta property="og:site_name" content="24号程序猿">
<meta property="og:description" content="前言Android Studio 从2.0开始就支持了Instant Run ，大大减少了应用编译时长，提升了开发效率。本文将结合Instant Run的源码抛砖引玉，揭开Instant Run 背后的秘密。如有不当之处，烦请不吝赐教。contact me ：bboylin24@gmail.com 本文为作者原创，转载须注明出处。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://bboylin.github.io/images/ir-hierarchy.png">
<meta property="og:image" content="https://bboylin.github.io/images/ir-debug.png">
<meta property="og:image" content="https://bboylin.github.io/images/ws-resources-debug.apk.png">
<meta property="og:image" content="https://bboylin.github.io/images/ws-dex.png">
<meta property="og:updated_time" content="2019-03-16T15:51:46.049Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="InstantRun原理以及源码分析">
<meta name="twitter:description" content="前言Android Studio 从2.0开始就支持了Instant Run ，大大减少了应用编译时长，提升了开发效率。本文将结合Instant Run的源码抛砖引玉，揭开Instant Run 背后的秘密。如有不当之处，烦请不吝赐教。contact me ：bboylin24@gmail.com 本文为作者原创，转载须注明出处。">
<meta name="twitter:image" content="https://bboylin.github.io/images/ir-hierarchy.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://bboylin.github.io/2019/03/15/InstantRun源码分析/">





  <title>InstantRun原理以及源码分析 | 24号程序猿</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">24号程序猿</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bboylin.github.io/2019/03/15/InstantRun源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="bboylin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/16531906?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="24号程序猿">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">InstantRun原理以及源码分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-15T21:08:52+08:00">
                2019-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/15/InstantRun源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/15/InstantRun源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Android Studio 从2.0开始就支持了Instant Run ，大大减少了应用编译时长，提升了开发效率。本文将结合Instant Run的源码抛砖引玉，揭开Instant Run 背后的秘密。如有不当之处，烦请不吝赐教。contact me ：<a href="mailto:bboylin24@gmail.com" target="_blank" rel="noopener">bboylin24@gmail.com</a> 本文为作者原创，转载须注明出处。<a id="more"></a></p>
<h3 id="OverView"><a href="#OverView" class="headerlink" title="OverView"></a>OverView</h3><p>Instant Run将一次增量编译划分为三种类型：</p>
<ul>
<li>Hot Swap : 仅仅是方法内部逻辑的更改，无需重启activity或者app，即时生效。</li>
<li>Warm Swap ： 涉及到resource的修改。需要重启activity才能生效。</li>
<li>Cold Swap ：涉及到类结构的更改，例如新增了一个方法，或者方法签名修改了。需要重启app。</li>
</ul>
<p>整体的思路是埋点，在每个类实例中插入一个IncrementalChange类型的$change字段，每个方法前插入一段判断逻辑，如果$change不为null，就把方法调用重定向到$change的对应方法上。假如方法逻辑有更新就更新辅助类，从而达到无需重启即可应用更改的能力。有些热修复框架也借鉴了这个思路。</p>
<p>为什么这样设计呢？直接更新这个类（计作A）不行吗？我们知道Java语言规范：</p>
<ul>
<li>同一个类不能被reload</li>
<li>判定两个类相同不仅要fully qualified name相同，而且class loader也必须同一个。否则会有ClassCastException。</li>
</ul>
<p>基于此：当A的实现变了的话无法实时更新。但是更新辅助类A$override就没有问题，因为A$override都实现了IncrementalChange接口，所以使用新的class loader去加载更新后的A$override实例并赋值给$change是没有问题的。这也是一种代理。</p>
<p>一些热修复和插件化框架也借鉴了资源的Warm Swap原理。主要是生成一个新的包含更新后的资源的AssetManager反射替换掉原先的AssetManager.</p>
<p>具体的细节后文再结合源码分析。</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>InstantRun的设计遵循C/S模型，源码分以下几个层级：</p>
<p><img src="/images/ir-hierarchy.png" alt></p>
<p>其中client负责将studio build产生的增量产物转化成patch数据通过socket传输给server，runtime是会打进apk的运行期会使用到的类，common是几个都会用的类和常量，server是在app上运行的，负责接受patch数据并且apply patch数据。annotation只有<code>DisableInstantRun</code>这一个注解，标记方法，类或包不使用instant-run：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotate a method, a class, a package when InstantRun should be disabled for the annotated</span></span><br><span class="line"><span class="comment"> * element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</span><br><span class="line"><span class="meta">@Target</span>(&#123;PACKAGE, TYPE, CONSTRUCTOR, METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DisableInstantRun &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们点Android studio run这个按钮右边的⚡️就可以使用InstantRun应用最新的更改，前提是在Preferences里开了enable InstantRun。我们来看下，第一次点run发生了什么：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">adb install-multiple -r -t /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_0.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_3.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_8.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_9.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/resources/instant-run/debug/resources-debug.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/dep/dependencies.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_2.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_7.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_5.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_4.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_6.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_1.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/instant-run-apk/debug/app-debug.apk </span><br><span class="line">Split APKs installed</span><br><span class="line">$ adb shell am start -n <span class="string">"com.baidu.swan/com.baidu.swan.MainActivity"</span> -a android.intent.action.MAIN -c android.intent.category.LAUNCHER</span><br><span class="line">Client not ready yet..Waiting <span class="keyword">for</span> process to come online</span><br><span class="line">Connected to process 3519 on device 8cd2bb1b</span><br><span class="line">Capturing and displaying logcat messages from application. This behavior can be disabled <span class="keyword">in</span> the <span class="string">"Logcat output"</span> section of the <span class="string">"Debugger"</span> settings page.</span><br><span class="line">W/ResourceType: No package identifier when getting name <span class="keyword">for</span> resource number 0x00000000</span><br><span class="line">I/InstantRun: starting instant run server: is main process</span><br></pre></td></tr></table></figure></p>
<p>可以看到不同于正常的run流程，启用了instantRun之后一次安装了app-debug.apk, dependencies.apk, resources-debug.apk，以及10个slice apk。可以看到app-debug.apk完全没有我们写的代码，主要是IR（InstantRun简称，后同） server的代码；dependencies.apk主要是依赖的framework的代码；resources-debug.apk里没有dex,都是资源文件；slice apk里是我们真正写的代码。可以看到这些apk里找不到我们所说的带<code>$override</code>后缀的class。后面我们再说。</p>
<h4 id="Hot-Swap"><a href="#Hot-Swap" class="headerlink" title="Hot Swap"></a>Hot Swap</h4><p>在transform下的instantrun目录可以找到transform后的MainActivity：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6288346222584639322L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IncrementalChange var1 = $change;</span><br><span class="line">        <span class="keyword">if</span> (var1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object[] var10001 = (Object[])var1.access$dispatch(<span class="string">"init$args.([Lcom/baidu/swan/MainActivity;[Ljava/lang/Object;)Ljava/lang/Object;"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;);</span><br><span class="line">            Object[] var2 = (Object[])var10001[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">this</span>(var10001, (InstantReloadException)<span class="keyword">null</span>);</span><br><span class="line">            var2[<span class="number">0</span>] = <span class="keyword">this</span>;</span><br><span class="line">            var1.access$dispatch(<span class="string">"init$body.(Lcom/baidu/swan/MainActivity;[Ljava/lang/Object;)V"</span>, var2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        IncrementalChange var2 = $change;</span><br><span class="line">        <span class="keyword">if</span> (var2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var2.access$dispatch(<span class="string">"onCreate.(Landroid/os/Bundle;)V"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, savedInstanceState&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">            <span class="keyword">this</span>.setContentView(<span class="number">2131296284</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IncrementalChange var1 = $change;</span><br><span class="line">        <span class="keyword">if</span> (var1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var1.access$dispatch(<span class="string">"onResume.()V"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.onResume();</span><br><span class="line">            <span class="keyword">this</span>.startAction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IncrementalChange var1 = $change;</span><br><span class="line">        <span class="keyword">if</span> (var1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var1.access$dispatch(<span class="string">"startAction.()V"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            (<span class="keyword">new</span> DemoAction()).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MainActivity(Object[] var1, InstantReloadException var2) &#123;</span><br><span class="line">        String var3 = (String)var1[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">switch</span>(var3.hashCode()) &#123;</span><br><span class="line">        <span class="keyword">case</span> -<span class="number">2089128195</span>:</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">247605451</span>:</span><br><span class="line">            <span class="keyword">this</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InstantReloadException(String.format(<span class="string">"String switch could not find '%s' with hashcode %s in %s"</span>, var3, var3.hashCode(), <span class="string">"com/baidu/swan/MainActivity"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>很容易看出来，还少了一个$change字段的定义，从slice apk里MainActivity的字节码可以看出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># static fields</span><br><span class="line">.field <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">transient</span> synthetic $change:Lcom/android/tools/ir/runtime/IncrementalChange; = <span class="keyword">null</span></span><br></pre></td></tr></table></figure></p>
<p>$change这个字段是volatile transient synthetic的。synthetic是属性表中的一种定长属性，凡是不出现在源码中的字段必须用synthetic标识。并且$change是IncrementalChange类型。<br>从生成的代码可以知道，当$change不为null的时候，所有方法会代理到$change的access$dispatch方法。例如onCreate调的是：<code>access$dispatch(&quot;onCreate.(Landroid/os/Bundle;)V&quot;, new Object[]{this, savedInstanceState});</code>。我们打断点可以验证，其实是调的MainActivity$override的方法。</p>
<p><img src="/images/ir-debug.png" alt></p>
<p>在transform下的InstantRun目录下可以看到MainActivity$override的源码，实现了IncrementalChange接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span>$<span class="title">override</span> <span class="keyword">implements</span> <span class="title">IncrementalChange</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> MainActivity$override() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object init$args(MainActivity[] var0, Object[] var1) &#123;</span><br><span class="line">        Object[] var2 = <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> Object[]&#123;var0, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;, <span class="string">"android/support/v7/app/AppCompatActivity.()V"</span>&#125;;</span><br><span class="line">        <span class="keyword">return</span> var2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> init$body(MainActivity $<span class="keyword">this</span>, Object[] var1) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(MainActivity $<span class="keyword">this</span>, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        Object[] var2 = <span class="keyword">new</span> Object[]&#123;savedInstanceState&#125;;</span><br><span class="line">        MainActivity.access$<span class="keyword">super</span>($<span class="keyword">this</span>, <span class="string">"onCreate.(Landroid/os/Bundle;)V"</span>, var2);</span><br><span class="line">        $<span class="keyword">this</span>.setContentView(<span class="number">2131296284</span>);</span><br><span class="line">        Log.d(<span class="string">"tag"</span>, <span class="string">"instant run patch ----"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">(MainActivity $<span class="keyword">this</span>)</span> </span>&#123;</span><br><span class="line">        Object[] var1 = <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br><span class="line">        MainActivity.access$<span class="keyword">super</span>($<span class="keyword">this</span>, <span class="string">"onResume.()V"</span>, var1);</span><br><span class="line">        $<span class="keyword">this</span>.startAction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startAction</span><span class="params">(MainActivity $<span class="keyword">this</span>)</span> </span>&#123;</span><br><span class="line">        Object[] var1 = <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br><span class="line">        Class[] var10001 = <span class="keyword">new</span> Class[<span class="number">0</span>];</span><br><span class="line">        String var10002 = <span class="string">"&lt;init&gt;"</span>;</span><br><span class="line">        ((DemoAction)((DemoAction)AndroidInstantRuntime.newForClass(var1, var10001, DemoAction.class))).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object access$dispatch(String var1, Object... var2) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(var1.hashCode()) &#123;</span><br><span class="line">        <span class="keyword">case</span> -<span class="number">1512649357</span>:</span><br><span class="line">            onResume((MainActivity)var2[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">case</span> -<span class="number">1058486495</span>:</span><br><span class="line">            <span class="keyword">return</span> init$args((MainActivity[])var2[<span class="number">0</span>], (Object[])var2[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">case</span> -<span class="number">776359727</span>:</span><br><span class="line">            init$body((MainActivity)var2[<span class="number">0</span>], (Object[])var2[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">case</span> -<span class="number">641568046</span>:</span><br><span class="line">            onCreate((MainActivity)var2[<span class="number">0</span>], (Bundle)var2[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">case</span> -<span class="number">544012865</span>:</span><br><span class="line">            startAction((MainActivity)var2[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InstantReloadException(String.format(<span class="string">"String switch could not find '%s' with hashcode %s in %s"</span>, var1, var1.hashCode(), <span class="string">"com/baidu/swan/MainActivity"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以知道对MainActivity任意方法的调用会代理到MainActivity$override的access$dispatch方法，传入一个类似方法签名的字符串，access$dispatch根据这个字符串的hashcode分发到MainActivity$override对应的方法中。</p>
<p>下面来看下IR源码，从client的pushPatches方法开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> UpdateMode <span class="title">pushPatches</span><span class="params">(@NonNull IDevice device,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull <span class="keyword">final</span> InstantRunBuildInfo buildInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull UpdateMode updateMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">boolean</span> isRestartActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">boolean</span> isShowToastEnabled)</span> <span class="keyword">throws</span> InstantRunPushFailedException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!buildInfo.canHotswap()) &#123;</span><br><span class="line">        updateMode = updateMode.combine(UpdateMode.COLD_SWAP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;FileTransfer&gt; files = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> appInForeground;</span><br><span class="line">    <span class="keyword">boolean</span> appRunning;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AppState appState = getAppState(device);</span><br><span class="line">        appInForeground = appState == AppState.FOREGROUND;</span><br><span class="line">        appRunning = appState == AppState.FOREGROUND || appState == AppState.BACKGROUND;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        appInForeground = appRunning = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;InstantRunArtifact&gt; artifacts = buildInfo.getArtifacts();</span><br><span class="line">    mLogger.info(<span class="string">"Artifacts from build-info.xml: "</span> + Joiner.on(<span class="string">"-"</span>).join(artifacts));</span><br><span class="line">    <span class="keyword">for</span> (InstantRunArtifact artifact : artifacts) &#123;</span><br><span class="line">        InstantRunArtifactType type = artifact.type;</span><br><span class="line">        File file = artifact.file;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> MAIN:</span><br><span class="line">                <span class="comment">// Should never be used with this method: APKs should be pushed by DeployApkTask</span></span><br><span class="line">                <span class="keyword">assert</span> <span class="keyword">false</span> : artifact;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SPLIT_MAIN:</span><br><span class="line">                <span class="comment">// Should only be used here when we're doing a *compatible*</span></span><br><span class="line">                <span class="comment">// resource swap and also got an APK for split. Ignore here.</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> SPLIT:</span><br><span class="line">                <span class="comment">// we expect SPLIT APK for resource changes on O and above</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> RESOURCES:</span><br><span class="line">                updateMode = updateMode.combine(UpdateMode.WARM_SWAP);</span><br><span class="line">                files.add(FileTransfer.createResourceFile(file));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RELOAD_DEX:</span><br><span class="line">                <span class="keyword">if</span> (appInForeground) &#123;</span><br><span class="line">                    files.add(FileTransfer.createHotswapPatch(file));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Gradle created a reload dex, but the app is no longer running.</span></span><br><span class="line">                    <span class="comment">// If it created a cold swap artifact, we can use it; otherwise we're out of luck.</span></span><br><span class="line">                    <span class="keyword">if</span> (!buildInfo.hasOneOf(SPLIT)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> InstantRunPushFailedException(</span><br><span class="line">                            <span class="string">"Can't apply hot swap patch: app is no longer running"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">assert</span> <span class="keyword">false</span> : artifact;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> needRestart;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (appRunning) &#123;</span><br><span class="line">        List&lt;ApplicationPatch&gt; changes = <span class="keyword">new</span> ArrayList&lt;&gt;(files.size());</span><br><span class="line">        <span class="keyword">for</span> (FileTransfer file : files) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                changes.add(file.getPatch());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InstantRunPushFailedException(<span class="string">"Could not read file "</span> + file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        updateMode = pushPatches(device, buildInfo.getTimeStamp(), changes,</span><br><span class="line">                                 updateMode, isRestartActivity, isShowToastEnabled);</span><br><span class="line"></span><br><span class="line">        needRestart = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!appInForeground || !buildInfo.canHotswap()) &#123;</span><br><span class="line">            stopApp(device, <span class="keyword">false</span> <span class="comment">/* sendChangeBroadcast */</span>);</span><br><span class="line">            needRestart = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UpdateMode.COLD_SWAP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logFilesPushed(files, needRestart);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needRestart) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> this should not need to be explicit, but leaving in to ensure no behaviour change.</span></span><br><span class="line">        <span class="keyword">return</span> UpdateMode.COLD_SWAP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updateMode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可知针对资源的更新采取的是warmSwap，针对reload dex，如果app在前台，产生一个hot swap 的patch；否则抛异常InstantRunPushFailedException：”Can’t apply hot swap patch: app is no longer running”。得到所有的更改patches后调用另一个pushPatches方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> UpdateMode <span class="title">pushPatches</span><span class="params">(@NonNull IDevice device,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull <span class="keyword">final</span> String buildId,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull <span class="keyword">final</span> List&lt;ApplicationPatch&gt; changes,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull UpdateMode updateMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">boolean</span> isRestartActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">boolean</span> isShowToastEnabled)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (changes.isEmpty() || updateMode == UpdateMode.NO_CHANGES) &#123;</span><br><span class="line">        <span class="comment">// Sync the build id to the device; Gradle might rev the build id</span></span><br><span class="line">        <span class="comment">// even when there are no changes, and we need to make sure that the</span></span><br><span class="line">        <span class="comment">// device id reflects this new build id, or the next build will</span></span><br><span class="line">        <span class="comment">// discover different id's and will conclude that it needs to do a</span></span><br><span class="line">        <span class="comment">// full rebuild</span></span><br><span class="line">        transferLocalIdToDeviceId(device, buildId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> UpdateMode.NO_CHANGES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateMode == UpdateMode.HOT_SWAP &amp;&amp; isRestartActivity) &#123;</span><br><span class="line">        updateMode = updateMode.combine(UpdateMode.WARM_SWAP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> UpdateMode updateMode1 = updateMode;</span><br><span class="line">    mAppService.talkToService(device, <span class="keyword">new</span> Communicator&lt;Boolean&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Boolean <span class="title">communicate</span><span class="params">(@NonNull DataInputStream input,</span></span></span><br><span class="line"><span class="function"><span class="params">                @NonNull DataOutputStream output)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            output.writeInt(MESSAGE_PATCHES);</span><br><span class="line">            writeToken(output);</span><br><span class="line">            ApplicationPatchUtil.write(output, changes, updateMode1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Let the app know whether it should show toasts</span></span><br><span class="line">            output.writeBoolean(isShowToastEnabled);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Finally read a boolean back from the other side; this has the net effect of</span></span><br><span class="line">            <span class="comment">// waiting until applying/verifying code on the other side is done. (It doesn't</span></span><br><span class="line">            <span class="comment">// count the actual restart time, but for activity restarts it's typically instant,</span></span><br><span class="line">            <span class="comment">// and for cold starts we have no easy way to handle it (the process will die and a</span></span><br><span class="line">            <span class="comment">// new process come up; to measure that we'll need to work a lot harder.)</span></span><br><span class="line">            input.readBoolean();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">getTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">8000</span>; <span class="comment">// allow up to 8 seconds for resource push</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    transferLocalIdToDeviceId(device, buildId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> updateMode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了ServiceCommunicator的talkToService方法，使用socket将patch数据发送给server的socket。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(DataInputStream input, DataOutputStream output)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> magic = input.readLong();</span><br><span class="line">    <span class="keyword">if</span> (magic != PROTOCOL_IDENTIFIER) &#123;</span><br><span class="line">        Log.w(Logging.LOG_TAG, <span class="string">"Unrecognized header format "</span> + Long.toHexString(magic));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> version = input.readInt();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send current protocol version to the IDE so it can decide what to do</span></span><br><span class="line">    output.writeInt(PROTOCOL_VERSION);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (version != PROTOCOL_VERSION) &#123;</span><br><span class="line">        Log.w(</span><br><span class="line">                Logging.LOG_TAG,</span><br><span class="line">                <span class="string">"Mismatched protocol versions; app is "</span></span><br><span class="line">                        + <span class="string">"using version "</span></span><br><span class="line">                        + PROTOCOL_VERSION</span><br><span class="line">                        + <span class="string">" and tool is using version "</span></span><br><span class="line">                        + version);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> message = input.readInt();</span><br><span class="line">        <span class="keyword">switch</span> (message) &#123;</span><br><span class="line">            <span class="keyword">case</span> MESSAGE_EOF:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                        Log.v(Logging.LOG_TAG, <span class="string">"Received EOF from the IDE"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MESSAGE_PING:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Send an "ack" back to the IDE.</span></span><br><span class="line">                    <span class="comment">// The value of the boolean is true only when the app is in the</span></span><br><span class="line">                    <span class="comment">// foreground.</span></span><br><span class="line">                    <span class="keyword">boolean</span> active = Restarter.getForegroundActivity(context) != <span class="keyword">null</span>;</span><br><span class="line">                    output.writeBoolean(active);</span><br><span class="line">                    <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                        Log.v(</span><br><span class="line">                                Logging.LOG_TAG,</span><br><span class="line">                                <span class="string">"Received Ping message from the IDE; "</span></span><br><span class="line">                                        + <span class="string">"returned active = "</span></span><br><span class="line">                                        + active);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MESSAGE_PATH_EXISTS:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (FileManager.USE_EXTRACTED_RESOURCES) &#123;</span><br><span class="line">                        String path = input.readUTF();</span><br><span class="line">                        <span class="keyword">long</span> size = FileManager.getFileSize(path);</span><br><span class="line">                        output.writeLong(size);</span><br><span class="line">                        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                            Log.v(</span><br><span class="line">                                    Logging.LOG_TAG,</span><br><span class="line">                                    <span class="string">"Received path-exists("</span></span><br><span class="line">                                            + path</span><br><span class="line">                                            + <span class="string">") from the "</span></span><br><span class="line">                                            + <span class="string">"IDE; returned size="</span></span><br><span class="line">                                            + size);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.ERROR)) &#123;</span><br><span class="line">                            Log.e(Logging.LOG_TAG, <span class="string">"Unexpected message type: "</span> + message);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MESSAGE_PATH_CHECKSUM:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (FileManager.USE_EXTRACTED_RESOURCES) &#123;</span><br><span class="line">                        <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">                        String path = input.readUTF();</span><br><span class="line">                        <span class="keyword">byte</span>[] checksum = FileManager.getCheckSum(path);</span><br><span class="line">                        <span class="keyword">if</span> (checksum != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            output.writeInt(checksum.length);</span><br><span class="line">                            output.write(checksum);</span><br><span class="line">                            <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                                <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">                                String hash = <span class="keyword">new</span> BigInteger(<span class="number">1</span>, checksum).toString(<span class="number">16</span>);</span><br><span class="line">                                Log.v(</span><br><span class="line">                                        Logging.LOG_TAG,</span><br><span class="line">                                        <span class="string">"Received checksum("</span></span><br><span class="line">                                                + path</span><br><span class="line">                                                + <span class="string">") from the "</span></span><br><span class="line">                                                + <span class="string">"IDE: took "</span></span><br><span class="line">                                                + (end - begin)</span><br><span class="line">                                                + <span class="string">"ms to compute "</span></span><br><span class="line">                                                + hash);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            output.writeInt(<span class="number">0</span>);</span><br><span class="line">                            <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                                Log.v(</span><br><span class="line">                                        Logging.LOG_TAG,</span><br><span class="line">                                        <span class="string">"Received checksum("</span></span><br><span class="line">                                                + path</span><br><span class="line">                                                + <span class="string">") from the "</span></span><br><span class="line">                                                + <span class="string">"IDE: returning &lt;null&gt;"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.ERROR)) &#123;</span><br><span class="line">                            Log.e(Logging.LOG_TAG, <span class="string">"Unexpected message type: "</span> + message);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MESSAGE_RESTART_ACTIVITY:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!authenticate(input)) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Activity activity = Restarter.getForegroundActivity(context);</span><br><span class="line">                    <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                            Log.v(Logging.LOG_TAG, <span class="string">"Restarting activity per user request"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        Restarter.restartActivityOnUiThread(activity);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MESSAGE_PATCHES: &#123;</span><br><span class="line">                <span class="keyword">if</span> (!authenticate(input)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                List&lt;ApplicationPatch&gt; changes = ApplicationPatch.read(input);</span><br><span class="line">                <span class="keyword">if</span> (changes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> hasResources = hasResources(changes);</span><br><span class="line">                <span class="keyword">int</span> updateMode = input.readInt();</span><br><span class="line">                updateMode = handlePatches(changes, hasResources, updateMode);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> showToast = input.readBoolean();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Send an "ack" back to the IDE; this is used for timing purposes only</span></span><br><span class="line">                output.writeBoolean(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                restart(updateMode, hasResources, showToast);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MESSAGE_SHOW_TOAST:</span><br><span class="line">                &#123;</span><br><span class="line">                    String text = input.readUTF();</span><br><span class="line">                    Activity foreground = Restarter.getForegroundActivity(context);</span><br><span class="line">                    <span class="keyword">if</span> (foreground != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Restarter.showToast(foreground, text);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                        Log.v(</span><br><span class="line">                                Logging.LOG_TAG,</span><br><span class="line">                                <span class="string">"Couldn't show toast (no activity) : "</span> + text);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.ERROR)) &#123;</span><br><span class="line">                        Log.e(Logging.LOG_TAG, <span class="string">"Unexpected message type: "</span> + message);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// If we hit unexpected message types we can't really continue</span></span><br><span class="line">                    <span class="comment">// the conversation: we can misinterpret data for the unexpected</span></span><br><span class="line">                    <span class="comment">// command as separate messages with different meanings than intended</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当接收到MESSAGE_PATCHES类型的message时候就调用handlePatches：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">handlePatches</span><span class="params">(@NonNull List&lt;ApplicationPatch&gt; changes, <span class="keyword">boolean</span> hasResources,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> updateMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hasResources) &#123;</span><br><span class="line">        FileManager.startUpdate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ApplicationPatch change : changes) &#123;</span><br><span class="line">        String path = change.getPath();</span><br><span class="line">        <span class="keyword">if</span> (path.equals(RELOAD_DEX_FILE_NAME)) &#123;</span><br><span class="line">            updateMode = handleHotSwapPatch(updateMode, change);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isResourcePath(path)) &#123;</span><br><span class="line">            updateMode = handleResourcePatch(updateMode, change, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasResources) &#123;</span><br><span class="line">        FileManager.finishUpdate(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> updateMode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>hot swap调用的是handleHotSwapPatch<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">handleHotSwapPatch</span><span class="params">(<span class="keyword">int</span> updateMode, @NonNull ApplicationPatch patch)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        Log.v(Logging.LOG_TAG, <span class="string">"Received incremental code patch"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String dexFile = FileManager.writeTempDexFile(patch.getBytes());</span><br><span class="line">        <span class="keyword">if</span> (dexFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.e(Logging.LOG_TAG, <span class="string">"No file to write the code to"</span>);</span><br><span class="line">            <span class="keyword">return</span> updateMode;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(Logging.LOG_TAG, <span class="string">"Reading live code from "</span> + dexFile);</span><br><span class="line">        &#125;</span><br><span class="line">        String nativeLibraryPath = FileManager.getNativeLibraryFolder().getPath();</span><br><span class="line">        DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(dexFile,</span><br><span class="line">                context.getCacheDir().getPath(), nativeLibraryPath,</span><br><span class="line">                getClass().getClassLoader());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we should transform this process with an interface/impl</span></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(</span><br><span class="line">                <span class="string">"com.android.tools.ir.runtime.AppPatchesLoaderImpl"</span>, <span class="keyword">true</span>, dexClassLoader);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                Log.v(Logging.LOG_TAG, <span class="string">"Got the patcher class "</span> + aClass);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            PatchesLoader loader = (PatchesLoader) aClass.newInstance();</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                Log.v(Logging.LOG_TAG, <span class="string">"Got the patcher instance "</span> + loader);</span><br><span class="line">            &#125;</span><br><span class="line">            String[] getPatchedClasses = (String[]) aClass</span><br><span class="line">                    .getDeclaredMethod(<span class="string">"getPatchedClasses"</span>).invoke(loader);</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                Log.v(Logging.LOG_TAG, <span class="string">"Got the list of classes "</span>);</span><br><span class="line">                <span class="keyword">for</span> (String getPatchedClass : getPatchedClasses) &#123;</span><br><span class="line">                    Log.v(Logging.LOG_TAG, <span class="string">"class "</span> + getPatchedClass);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!loader.load()) &#123;</span><br><span class="line">                updateMode = UPDATE_MODE_COLD_SWAP;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(Logging.LOG_TAG, <span class="string">"Couldn't apply code changes"</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            updateMode = UPDATE_MODE_COLD_SWAP;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        Log.e(Logging.LOG_TAG, <span class="string">"Couldn't apply code changes"</span>, e);</span><br><span class="line">        updateMode = UPDATE_MODE_COLD_SWAP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updateMode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先将patch中的byte数组通过writeTempDexFile写到手机里，保存成/data/data/applicationId/files/instant-run/dex-temp下的最新的一个reload0x0000.dex这种格式的文件。0x后面的四位表示的数越大，这个文件越新。我们找到这个dex可以发现，其实就两个类，一个是transform的时候生成的AppPatchesLoaderImpl，另一个是因为我们更改了MainActivity导致的MainActivity$override相应更改。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppPatchesLoaderImpl</span> <span class="keyword">extends</span> <span class="title">AbstractPatchesLoaderImpl</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BUILD_ID = <span class="number">1548383899788L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppPatchesLoaderImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getPatchedClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"com.baidu.swan.MainActivity"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getPatchedClasses实际上是一个override的方法，返回修改过的类名。</p>
<p>接着往下看，创建了一个DexClassLoader实例，然后利用它加载AppPatchesLoaderImpl这个类，反射创建AppPatchesLoaderImpl实例，调用getPatchedClasses方法。接着调用load方法。我们来看AbstractPatchesLoaderImpl的load方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> String[] getPatchedClasses();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (String className : getPatchedClasses()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取AppPatchesLoaderImpl的classLoader，通过前一步可知是新建的DexClassLoader实例</span></span><br><span class="line">            ClassLoader cl = getClass().getClassLoader();</span><br><span class="line">            Class&lt;?&gt; aClass = cl.loadClass(className + <span class="string">"$override"</span>);</span><br><span class="line">            Object o = aClass.newInstance();</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; originalClass = cl.loadClass(className);</span><br><span class="line">            Field changeField = originalClass.getDeclaredField(<span class="string">"$change"</span>);</span><br><span class="line">            <span class="comment">// force the field accessibility as the class might not be "visible"</span></span><br><span class="line">            <span class="comment">// from this package.</span></span><br><span class="line">            changeField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            Object previous =</span><br><span class="line">                    originalClass.isInterface()</span><br><span class="line">                            ? patchInterface(changeField, o)</span><br><span class="line">                            : patchClass(changeField, o);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If there was a previous change set, mark it as obsolete:</span></span><br><span class="line">            <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Field isObsolete = previous.getClass().getDeclaredField(<span class="string">"$obsolete"</span>);</span><br><span class="line">                <span class="keyword">if</span> (isObsolete != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    isObsolete.set(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span> &amp;&amp; logging.isLoggable(Level.FINE)) &#123;</span><br><span class="line">                logging.log(Level.FINE, String.format(<span class="string">"patched %s"</span>, className));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logging.log(</span><br><span class="line">                        Level.SEVERE,</span><br><span class="line">                        String.format(<span class="string">"Exception while patching %s"</span>, className),</span><br><span class="line">                        e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * When dealing with interfaces, the $change field is a final &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * java.util.concurrent.atomic.AtomicReference&#125; instance which contains the current patch class</span></span><br><span class="line"><span class="comment"> * or null if it was never patched.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> changeField the $change field.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> patch the patch class instance.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous patch instance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">patchInterface</span><span class="params">(Field changeField, Object patch)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalAccessException, NoSuchMethodException, InvocationTargetException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Object atomicReference = changeField.get(<span class="keyword">null</span>);</span><br><span class="line">    Object previous = get.invoke(atomicReference);</span><br><span class="line">    set.invoke(atomicReference, patch);</span><br><span class="line">    <span class="keyword">return</span> previous;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * When dealing with classes, the $change field is the patched class instance or null if it was</span></span><br><span class="line"><span class="comment"> * never patched.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> changeField the $change field.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> patch the patch class instance.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the previous patch instance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">patchClass</span><span class="params">(Field changeField, Object patch)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">    Object previous = changeField.get(<span class="keyword">null</span>);</span><br><span class="line">    changeField.set(<span class="keyword">null</span>, patch);</span><br><span class="line">    <span class="keyword">return</span> previous;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>反射创建更改的类对应的$override类的实例，赋给这个类的$change字段。正因如此，才能做到不重启activity实现Hot Swap ! </p>
<h4 id="Warm-Swap"><a href="#Warm-Swap" class="headerlink" title="Warm Swap"></a>Warm Swap</h4><p>回到之前InstantRunClient的源码看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> RESOURCES:</span><br><span class="line">    updateMode = updateMode.combine(UpdateMode.WARM_SWAP);</span><br><span class="line">    files.add(FileTransfer.createResourceFile(file));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FileTransfer <span class="title">createResourceFile</span><span class="params">(@NonNull File source)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FileTransfer(TRANSFER_MODE_RESOURCES, source, Paths.RESOURCE_FILE_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">......</span><br><span class="line">    <span class="comment">/** Name of file to write resource data into, if not extracting resources */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_FILE_NAME = <span class="string">"resources.ap_"</span>;</span><br></pre></td></tr></table></figure></p>
<p>结合之前的分析可知是将patch数据写入resources.ap_然后push到了server端。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">                <span class="keyword">case</span> MESSAGE_PATCHES: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!authenticate(input)) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    List&lt;ApplicationPatch&gt; changes = ApplicationPatch.read(input);</span><br><span class="line">                    <span class="keyword">if</span> (changes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> hasResources = hasResources(changes);</span><br><span class="line">                    <span class="keyword">int</span> updateMode = input.readInt();</span><br><span class="line">                    updateMode = handlePatches(changes, hasResources, updateMode);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> showToast = input.readBoolean();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Send an "ack" back to the IDE; this is used for timing purposes only</span></span><br><span class="line">                    output.writeBoolean(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    restart(updateMode, hasResources, showToast);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">......</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">handlePatches</span><span class="params">(@NonNull List&lt;ApplicationPatch&gt; changes, <span class="keyword">boolean</span> hasResources,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> updateMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hasResources) &#123;</span><br><span class="line">        FileManager.startUpdate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ApplicationPatch change : changes) &#123;</span><br><span class="line">        String path = change.getPath();</span><br><span class="line">        <span class="keyword">if</span> (path.equals(RELOAD_DEX_FILE_NAME)) &#123;</span><br><span class="line">            updateMode = handleHotSwapPatch(updateMode, change);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isResourcePath(path)) &#123;</span><br><span class="line">            updateMode = handleResourcePatch(updateMode, change, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasResources) &#123;</span><br><span class="line">        FileManager.finishUpdate(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> updateMode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handleResourcePatch</span><span class="params">(<span class="keyword">int</span> updateMode, @NonNull ApplicationPatch patch,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        Log.v(Logging.LOG_TAG, <span class="string">"Received resource changes ("</span> + path + <span class="string">")"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    FileManager.writeAaptResources(path, patch.getBytes());</span><br><span class="line">    <span class="comment">//noinspection ResourceType</span></span><br><span class="line">    updateMode = Math.max(updateMode, UPDATE_MODE_WARM_SWAP);</span><br><span class="line">    <span class="keyword">return</span> updateMode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>server收到warm swap消息和patch数据后先清空原来的resource更新文件，然后写入新的resources.ap_。接着调restart方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">restart</span><span class="params">(<span class="keyword">int</span> updateMode, <span class="keyword">boolean</span> incrementalResources, <span class="keyword">boolean</span> toast)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">        Log.v(Logging.LOG_TAG, <span class="string">"Finished loading changes; update mode ="</span> + updateMode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateMode == UPDATE_MODE_NONE || updateMode == UPDATE_MODE_HOT_SWAP) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(Logging.LOG_TAG, <span class="string">"Applying incremental code without restart"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (toast) &#123;</span><br><span class="line">            Activity foreground = Restarter.getForegroundActivity(context);</span><br><span class="line">            <span class="keyword">if</span> (foreground != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Restarter.showToast(foreground, <span class="string">"Applied code changes without activity "</span> +</span><br><span class="line">                        <span class="string">"restart"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                Log.v(Logging.LOG_TAG, <span class="string">"Couldn't show toast: no activity found"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Activity&gt; activities = Restarter.getActivities(context, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (incrementalResources &amp;&amp; updateMode == UPDATE_MODE_WARM_SWAP) &#123;</span><br><span class="line">        <span class="comment">// Try to just replace the resources on the fly!</span></span><br><span class="line">        File file = FileManager.getExternalResourceFile();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(</span><br><span class="line">                    Logging.LOG_TAG,</span><br><span class="line">                    <span class="string">"About to update resource file="</span> + file + <span class="string">", activities="</span> + activities);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String resources = file.getPath();</span><br><span class="line">            MonkeyPatcher.monkeyPatchExistingResources(context, resources, activities);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(Logging.LOG_TAG, <span class="string">"No resource file found to apply"</span>);</span><br><span class="line">            updateMode = UPDATE_MODE_COLD_SWAP;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Activity activity = Restarter.getForegroundActivity(context);</span><br><span class="line">    <span class="keyword">if</span> (updateMode == UPDATE_MODE_WARM_SWAP) &#123;</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                Log.v(Logging.LOG_TAG, <span class="string">"Restarting activity only!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> handledRestart = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Allow methods to handle their own restart by implementing</span></span><br><span class="line">                <span class="comment">//     public boolean onHandleCodeChange(long flags) &#123; .... &#125;</span></span><br><span class="line">                <span class="comment">// and returning true if the change was handled manually</span></span><br><span class="line">                Method method = activity.getClass().getMethod(<span class="string">"onHandleCodeChange"</span>, Long.TYPE);</span><br><span class="line">                Object result = method.invoke(activity, <span class="number">0L</span>);</span><br><span class="line">                <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                    Log.v(</span><br><span class="line">                            Logging.LOG_TAG,</span><br><span class="line">                            <span class="string">"Activity "</span></span><br><span class="line">                                    + activity</span><br><span class="line">                                    + <span class="string">" provided manual restart method; return "</span></span><br><span class="line">                                    + result);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (Boolean.TRUE.equals(result)) &#123;</span><br><span class="line">                    handledRestart = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (toast) &#123;</span><br><span class="line">                        Restarter.showToast(activity, <span class="string">"Applied changes"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!handledRestart) &#123;</span><br><span class="line">                <span class="keyword">if</span> (toast) &#123;</span><br><span class="line">                    Restarter.showToast(activity, <span class="string">"Applied changes, restarted activity"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                Restarter.restartActivityOnUiThread(activity);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(</span><br><span class="line">                    Logging.LOG_TAG,</span><br><span class="line">                    <span class="string">"No activity found, falling through to do a full app restart"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        updateMode = UPDATE_MODE_COLD_SWAP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateMode != UPDATE_MODE_COLD_SWAP) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.ERROR)) &#123;</span><br><span class="line">            Log.e(Logging.LOG_TAG, <span class="string">"Unexpected update mode: "</span> + updateMode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (RESTART_LOCALLY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(Logging.LOG_TAG, <span class="string">"Performing full app restart"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Restarter.restartApp(context, activities, toast);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(Logging.LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(Logging.LOG_TAG, <span class="string">"Waiting for app to be killed and restarted by the IDE..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可知Hot Swap会给取前台activity，弹toast。Warm Swap会MonkeyPatcher.monkeyPatchExistingResources进行资源替换。然后调Restarter重启activity。我们可以来看下Restarter这个类，觉得还是挺有用的。封装了重启activity，重启app，获取前台activity等方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handler capable of restarting parts of the application in order for changes to become apparent to</span></span><br><span class="line"><span class="comment"> * the user:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;Apply a tiny change immediately - possible if we can detect that the change is only used in</span></span><br><span class="line"><span class="comment"> *       a limited context (such as in a layout) and we can directly poke the view hierarchy and</span></span><br><span class="line"><span class="comment"> *       schedule a paint.</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;Apply a change to the current activity. We can restart just the activity while the app</span></span><br><span class="line"><span class="comment"> *       continues running.</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;Restart the app with state persistence (simulates what happens when a user puts an app in</span></span><br><span class="line"><span class="comment"> *       the background, then it gets killed by the memory monitor, and then restored when the user</span></span><br><span class="line"><span class="comment"> *       brings it back</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;Restart the app completely.</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Restarter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Restart an activity. Should preserve as much state as possible. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restartActivityOnUiThread</span><span class="params">(@NonNull <span class="keyword">final</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.runOnUiThread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                            Log.v(LOG_TAG, <span class="string">"Resources updated: notify activities"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        updateActivity(activity);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restartActivity</span><span class="params">(@NonNull Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(LOG_TAG, <span class="string">"About to restart "</span> + activity.getClass().getSimpleName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// You can't restart activities that have parents: find the top-most activity</span></span><br><span class="line">        <span class="keyword">while</span> (activity.getParent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                Log.v(</span><br><span class="line">                        LOG_TAG,</span><br><span class="line">                        activity.getClass().getSimpleName()</span><br><span class="line">                                + <span class="string">" is not a top level activity; restarting "</span></span><br><span class="line">                                + activity.getParent().getClass().getSimpleName()</span><br><span class="line">                                + <span class="string">" instead"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            activity = activity.getParent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Directly supported by the framework!</span></span><br><span class="line">        activity.recreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempt to restart the app. Ideally this should also try to preserve as much state as</span></span><br><span class="line"><span class="comment">     * possible:</span></span><br><span class="line"><span class="comment">     * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">     *     &lt;li&gt;The current activity&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *     &lt;li&gt;If possible, state in the current activity, and&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *     &lt;li&gt;The activity stack&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This may require some framework support. Apparently it may already be possible</span></span><br><span class="line"><span class="comment">     * (Dianne says to put the app in the background, kill it then restart it; need to</span></span><br><span class="line"><span class="comment">     * figure out how to do this.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restartApp</span><span class="params">(@Nullable Context appContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  @NonNull Collection&lt;Activity&gt; knownActivities,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">boolean</span> toast)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!knownActivities.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// Can't live patch resources; instead, try to restart the current activity</span></span><br><span class="line">            Activity foreground = getForegroundActivity(appContext);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (foreground != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// http://stackoverflow.com/questions/6609414/howto-programatically-restart-android-app</span></span><br><span class="line">                <span class="comment">//noinspection UnnecessaryLocalVariable</span></span><br><span class="line">                <span class="keyword">if</span> (toast) &#123;</span><br><span class="line">                    showToast(foreground, <span class="string">"Restarting app to apply incompatible changes"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                    Log.v(LOG_TAG, <span class="string">"RESTARTING APP"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"UnnecessaryLocalVariable"</span>) <span class="comment">// fore code clarify</span></span><br><span class="line">                Context context = foreground;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(context, foreground.getClass());</span><br><span class="line">                <span class="keyword">int</span> intentId = <span class="number">0</span>;</span><br><span class="line">                PendingIntent pendingIntent = PendingIntent.getActivity(context, intentId,</span><br><span class="line">                        intent, PendingIntent.FLAG_CANCEL_CURRENT);</span><br><span class="line">                AlarmManager mgr = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">                mgr.set(AlarmManager.RTC, System.currentTimeMillis() + <span class="number">100</span>, pendingIntent);</span><br><span class="line">                <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                    Log.v(</span><br><span class="line">                            LOG_TAG,</span><br><span class="line">                            <span class="string">"Scheduling activity "</span></span><br><span class="line">                                    + foreground</span><br><span class="line">                                    + <span class="string">" to start after exiting process"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                showToast(knownActivities.iterator().next(), <span class="string">"Unable to restart app"</span>);</span><br><span class="line">                <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                    Log.v(</span><br><span class="line">                            LOG_TAG,</span><br><span class="line">                            <span class="string">"Couldn't find any foreground activities to restart "</span></span><br><span class="line">                                    + <span class="string">"for resource refresh"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(@NonNull <span class="keyword">final</span> Activity activity, @NonNull <span class="keyword">final</span> String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            Log.v(LOG_TAG, <span class="string">"About to show toast for activity "</span> + activity + <span class="string">": "</span> + text);</span><br><span class="line">        &#125;</span><br><span class="line">        activity.runOnUiThread(</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Context context = activity.getApplicationContext();</span><br><span class="line">                            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</span><br><span class="line">                                Context base = ((ContextWrapper) context).getBaseContext();</span><br><span class="line">                                <span class="keyword">if</span> (base == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.WARN)) &#123;</span><br><span class="line">                                        Log.w(LOG_TAG, <span class="string">"Couldn't show toast: no base context"</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">return</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// For longer messages, leave the message up longer</span></span><br><span class="line">                            <span class="keyword">int</span> duration = Toast.LENGTH_SHORT;</span><br><span class="line">                            <span class="keyword">if</span> (text.length() &gt;= <span class="number">60</span> || text.indexOf(<span class="string">'\n'</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                                duration = Toast.LENGTH_LONG;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// Avoid crashing when not available, e.g.</span></span><br><span class="line">                            <span class="comment">//   java.lang.RuntimeException: Can't create handler inside thread that has</span></span><br><span class="line">                            <span class="comment">//        not called Looper.prepare()</span></span><br><span class="line">                            Toast.makeText(activity, text, duration).show();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.WARN)) &#123;</span><br><span class="line">                                Log.w(LOG_TAG, <span class="string">"Couldn't show toast"</span>, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Activity <span class="title">getForegroundActivity</span><span class="params">(@Nullable Context context)</span> </span>&#123;</span><br><span class="line">        List&lt;Activity&gt; list = getActivities(context, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> list.isEmpty() ? <span class="keyword">null</span> : list.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://stackoverflow.com/questions/11411395/how-to-get-current-foreground-activity-context-in-android</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Activity&gt; <span class="title">getActivities</span><span class="params">(@Nullable Context context, <span class="keyword">boolean</span> foregroundOnly)</span> </span>&#123;</span><br><span class="line">        List&lt;Activity&gt; list = <span class="keyword">new</span> ArrayList&lt;Activity&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">            Object activityThread = MonkeyPatcher.getActivityThread(context, activityThreadClass);</span><br><span class="line">            Field activitiesField = activityThreadClass.getDeclaredField(<span class="string">"mActivities"</span>);</span><br><span class="line">            activitiesField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// check app hasn't crashed, if it has, return empty list of activities.</span></span><br><span class="line">            <span class="keyword">if</span> (hasAppCrashed(context, activityThreadClass, activityThread)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Activity&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Collection c;</span><br><span class="line">            Object collection = activitiesField.get(activityThread);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (collection <span class="keyword">instanceof</span> HashMap) &#123;</span><br><span class="line">                <span class="comment">// Older platforms</span></span><br><span class="line">                Map activities = (HashMap) collection;</span><br><span class="line">                c = activities.values();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT &amp;&amp;</span><br><span class="line">                    collection <span class="keyword">instanceof</span> ArrayMap) &#123;</span><br><span class="line">                ArrayMap activities = (ArrayMap) collection;</span><br><span class="line">                c = activities.values();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> list;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Object activityClientRecord : c) &#123;</span><br><span class="line">                Class activityClientRecordClass = activityClientRecord.getClass();</span><br><span class="line">                <span class="keyword">if</span> (foregroundOnly) &#123;</span><br><span class="line">                    Field pausedField = activityClientRecordClass.getDeclaredField(<span class="string">"paused"</span>);</span><br><span class="line">                    pausedField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (pausedField.getBoolean(activityClientRecord)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Field activityField = activityClientRecordClass.getDeclaredField(<span class="string">"activity"</span>);</span><br><span class="line">                activityField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Activity activity = (Activity) activityField.get(activityClientRecord);</span><br><span class="line">                <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    list.add(activity);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.WARN)) &#123;</span><br><span class="line">                Log.w(LOG_TAG, <span class="string">"Error retrieving activities"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks if the application has crashed by comparing the package name against the list of</span></span><br><span class="line"><span class="comment">     * processes in error state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasAppCrashed</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull Class activityThreadClass,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Object activityThread)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span> || activityThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String currentPackageName = getPackageName(activityThreadClass, activityThread);</span><br><span class="line"></span><br><span class="line">        ActivityManager manager =</span><br><span class="line">                (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">        List&lt;ActivityManager.ProcessErrorStateInfo&gt; processesInErrorState =</span><br><span class="line">                manager.getProcessesInErrorState();</span><br><span class="line">        <span class="keyword">if</span> (processesInErrorState != <span class="keyword">null</span>) &#123; <span class="comment">// returns null if no process in error state</span></span><br><span class="line">            <span class="keyword">for</span> (ActivityManager.ProcessErrorStateInfo info : processesInErrorState) &#123;</span><br><span class="line">                <span class="keyword">if</span> (info.processName.equals(currentPackageName) &amp;&amp; info.condition != NO_ERROR) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Log.isLoggable(LOG_TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                        Log.v(LOG_TAG, <span class="string">"App Thread has crashed, return empty activity list."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use reflection to determine the package name from activity thread.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getPackageName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull Class activityThreadClass, @Nullable Object activityThread)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line">        Method currentPackageNameMethod =</span><br><span class="line">                activityThreadClass.getDeclaredMethod(<span class="string">"currentPackageName"</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) currentPackageNameMethod.invoke(activityThread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateActivity</span><span class="params">(@NonNull Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// This method can be called for activities that are not in the foreground, as long</span></span><br><span class="line">        <span class="comment">// as some of its resources have been updated. Therefore we'll need to make sure</span></span><br><span class="line">        <span class="comment">// that this activity is in the foreground, and if not do nothing. Ways to do</span></span><br><span class="line">        <span class="comment">// that are outlined here:</span></span><br><span class="line">        <span class="comment">// http://stackoverflow.com/questions/3667022/checking-if-an-android-application-is-running-in-the-background/5862048#5862048</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Try to force re-layout; there are many approaches; see</span></span><br><span class="line">        <span class="comment">// http://stackoverflow.com/questions/5991968/how-to-force-an-entire-layout-view-refresh</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This doesn't seem to update themes properly -- may need to do recreate() instead!</span></span><br><span class="line">        <span class="comment">//getWindow().getDecorView().findViewById(android.R.id.content).invalidate();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is a bit of a sledgehammer. We should consider having an incremental updater,</span></span><br><span class="line">        <span class="comment">// similar to IntelliJ's Look &amp;amp; Feel updater which iterates to the view hierarchy</span></span><br><span class="line">        <span class="comment">// and tries to incrementally refresh the LAF delegates and force a repaint.</span></span><br><span class="line">        <span class="comment">// On the other hand, we may never be able to succeed with that, since there could be</span></span><br><span class="line">        <span class="comment">// UI elements on the screen cached from callbacks. I should probably *not* attempt</span></span><br><span class="line">        <span class="comment">// to try to poke the user's data models; recreating the current layout should be</span></span><br><span class="line">        <span class="comment">// enough (e.g. if a layout references @string/foo, we'll recreate those widgets</span></span><br><span class="line">        <span class="comment">//    if (mLastContentView != -1) &#123;</span></span><br><span class="line">        <span class="comment">//        setContentView(mLastContentView);</span></span><br><span class="line">        <span class="comment">//    &#125; else &#123;</span></span><br><span class="line">        <span class="comment">//        recreate();</span></span><br><span class="line">        <span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">// -- nope, even that's iffy. I had code which *after* calling setContentView would</span></span><br><span class="line">        <span class="comment">// do some findViewById calls etc to reinitialize views.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// So what I should really try to do is have some knowledge about what changed,</span></span><br><span class="line">        <span class="comment">// and see if I can figure out that the change is minor (e.g. doesn't affect themes</span></span><br><span class="line">        <span class="comment">// or layout parameters etc), and if so, just try to poke the view hierarchy directly,</span></span><br><span class="line">        <span class="comment">// and if not, just recreate</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//    if (changeManager.isSimpleDelta()) &#123;</span></span><br><span class="line">        <span class="comment">//        changeManager.applyDirectly(this);</span></span><br><span class="line">        <span class="comment">//    &#125; else &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note: This doesn't handle manifest changes like changing the application title</span></span><br><span class="line"></span><br><span class="line">        restartActivity(activity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看下核心的MonkeyPatcher.monkeyPatchExistingResources方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">monkeyPatchExistingResources</span><span class="params">(@Nullable Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                @Nullable String externalResourceFile,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                @Nullable Collection&lt;Activity&gt; activities)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (externalResourceFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Create a new AssetManager instance and point it to the resources installed under</span></span><br><span class="line">        <span class="comment">// /sdcard</span></span><br><span class="line">        AssetManager newAssetManager = AssetManager.class.getConstructor().newInstance();</span><br><span class="line">        Method mAddAssetPath = AssetManager.class.getDeclaredMethod(<span class="string">"addAssetPath"</span>, String.class);</span><br><span class="line">        mAddAssetPath.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (((Integer) mAddAssetPath.invoke(newAssetManager, externalResourceFile)) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Could not create new AssetManager"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Kitkat needs this method call, Lollipop doesn't. However, it doesn't seem to cause any harm</span></span><br><span class="line">        <span class="comment">// in L, so we do it unconditionally.</span></span><br><span class="line">        Method mEnsureStringBlocks = AssetManager.class.getDeclaredMethod(<span class="string">"ensureStringBlocks"</span>);</span><br><span class="line">        mEnsureStringBlocks.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        mEnsureStringBlocks.invoke(newAssetManager);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Activity activity : activities) &#123;</span><br><span class="line">                Resources resources = activity.getResources();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Field mAssets = Resources.class.getDeclaredField(<span class="string">"mAssets"</span>);</span><br><span class="line">                    mAssets.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    mAssets.set(resources, newAssetManager);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                    Field mResourcesImpl = Resources.class.getDeclaredField(<span class="string">"mResourcesImpl"</span>);</span><br><span class="line">                    mResourcesImpl.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    Object resourceImpl = mResourcesImpl.get(resources);</span><br><span class="line">                    Field implAssets = resourceImpl.getClass().getDeclaredField(<span class="string">"mAssets"</span>);</span><br><span class="line">                    implAssets.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    implAssets.set(resourceImpl, newAssetManager);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Resources.Theme theme = activity.getTheme();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Field ma = Resources.Theme.class.getDeclaredField(<span class="string">"mAssets"</span>);</span><br><span class="line">                        ma.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        ma.set(theme, newAssetManager);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchFieldException ignore) &#123;</span><br><span class="line">                        Field themeField = Resources.Theme.class.getDeclaredField(<span class="string">"mThemeImpl"</span>);</span><br><span class="line">                        themeField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        Object impl = themeField.get(theme);</span><br><span class="line">                        Field ma = impl.getClass().getDeclaredField(<span class="string">"mAssets"</span>);</span><br><span class="line">                        ma.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        ma.set(impl, newAssetManager);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Field mt = ContextThemeWrapper.class.getDeclaredField(<span class="string">"mTheme"</span>);</span><br><span class="line">                    mt.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    mt.set(activity, <span class="keyword">null</span>);</span><br><span class="line">                    Method mtm = ContextThemeWrapper.class.getDeclaredMethod(<span class="string">"initializeTheme"</span>);</span><br><span class="line">                    mtm.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    mtm.invoke(activity);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (SDK_INT &lt; <span class="number">24</span>) &#123; <span class="comment">// As of API 24, mTheme is gone (but updates work</span></span><br><span class="line">                                        <span class="comment">// without these changes</span></span><br><span class="line">                        Method mCreateTheme = AssetManager.class</span><br><span class="line">                                .getDeclaredMethod(<span class="string">"createTheme"</span>);</span><br><span class="line">                        mCreateTheme.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        Object internalTheme = mCreateTheme.invoke(newAssetManager);</span><br><span class="line">                        Field mTheme = Resources.Theme.class.getDeclaredField(<span class="string">"mTheme"</span>);</span><br><span class="line">                        mTheme.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        mTheme.set(theme, internalTheme);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    Log.e(LOG_TAG, <span class="string">"Failed to update existing theme for activity "</span> + activity,</span><br><span class="line">                            e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                pruneResourceCaches(resources);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Iterate over all known Resources objects</span></span><br><span class="line">        Collection&lt;WeakReference&lt;Resources&gt;&gt; references;</span><br><span class="line">        <span class="keyword">if</span> (SDK_INT &gt;= KITKAT) &#123;</span><br><span class="line">            <span class="comment">// Find the singleton instance of ResourcesManager</span></span><br><span class="line">            Class&lt;?&gt; resourcesManagerClass = Class.forName(<span class="string">"android.app.ResourcesManager"</span>);</span><br><span class="line">            Method mGetInstance = resourcesManagerClass.getDeclaredMethod(<span class="string">"getInstance"</span>);</span><br><span class="line">            mGetInstance.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object resourcesManager = mGetInstance.invoke(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Field fMActiveResources = resourcesManagerClass.getDeclaredField(<span class="string">"mActiveResources"</span>);</span><br><span class="line">                fMActiveResources.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                ArrayMap&lt;?, WeakReference&lt;Resources&gt;&gt; arrayMap =</span><br><span class="line">                        (ArrayMap&lt;?, WeakReference&lt;Resources&gt;&gt;) fMActiveResources.get(resourcesManager);</span><br><span class="line">                references = arrayMap.values();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException ignore) &#123;</span><br><span class="line">                Field mResourceReferences = resourcesManagerClass.getDeclaredField(<span class="string">"mResourceReferences"</span>);</span><br><span class="line">                mResourceReferences.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">//noinspection unchecked</span></span><br><span class="line">                references = (Collection&lt;WeakReference&lt;Resources&gt;&gt;) mResourceReferences.get(resourcesManager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Class&lt;?&gt; activityThread = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">            Field fMActiveResources = activityThread.getDeclaredField(<span class="string">"mActiveResources"</span>);</span><br><span class="line">            fMActiveResources.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object thread = getActivityThread(context, activityThread);</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            HashMap&lt;?, WeakReference&lt;Resources&gt;&gt; map =</span><br><span class="line">                    (HashMap&lt;?, WeakReference&lt;Resources&gt;&gt;) fMActiveResources.get(thread);</span><br><span class="line">            references = map.values();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (WeakReference&lt;Resources&gt; wr : references) &#123;</span><br><span class="line">            Resources resources = wr.get();</span><br><span class="line">            <span class="keyword">if</span> (resources != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Set the AssetManager of the Resources instance to our brand new one</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Field mAssets = Resources.class.getDeclaredField(<span class="string">"mAssets"</span>);</span><br><span class="line">                    mAssets.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    mAssets.set(resources, newAssetManager);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                    Field mResourcesImpl = Resources.class.getDeclaredField(<span class="string">"mResourcesImpl"</span>);</span><br><span class="line">                    mResourcesImpl.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    Object resourceImpl = mResourcesImpl.get(resources);</span><br><span class="line">                    Field implAssets = resourceImpl.getClass().getDeclaredField(<span class="string">"mAssets"</span>);</span><br><span class="line">                    implAssets.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    implAssets.set(resourceImpl, newAssetManager);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                resources.updateConfiguration(resources.getConfiguration(), resources.getDisplayMetrics());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要是反射创建新的AssetManager，调用addAssetPath加入新增的resources，接着反射替换调所有 activity.getResources()，activity.getTheme()，ResourceManager的mResourceReferences这几个地方用到的AssetManager.</p>
<p>至此Warm Swap的主要流程也分析完了。如果Warm Swap没找到前台activity的话也会降级成Cold Swap。</p>
<h4 id="Cold-Swap"><a href="#Cold-Swap" class="headerlink" title="Cold Swap"></a>Cold Swap</h4><p>涉及到类结构改变的修改（例如manifest ，方法签名，新增字段，继承关系变化）等会使用Cold Swap。如今的Cold Swap不同于以往，以往是采用的split dex 作为instantrun.zip打到同一个apk包里，现在会redex和package，但是只会产生涉及到修改类的split apk，然后install-multiple执行一个partial install，重启app达到修改的效果。</p>
<p>我们新加一个icon试下看，你可能会误认为这是一次Warm Swap，其实由于会生成新的资源id字段，而且不属于assets，所以这是一次Cold Swap。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01/25 15:37:45: Launching app</span><br><span class="line">$ adb install-multiple -r -t -p com.baidu.swan /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/resources/instant-run/debug/resources-debug.apk /Users/denglin03/Desktop/projects/DemoApp/app/build/intermediates/split-apk/debug/slices/slice_0.apk </span><br><span class="line">Split APKs installed</span><br><span class="line">$ adb shell am start -n <span class="string">"com.baidu.swan/com.baidu.swan.MainActivity"</span> -a android.intent.action.MAIN -c android.intent.category.LAUNCHER</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/ws-resources-debug.apk.png" alt></p>
<p><img src="/images/ws-dex.png" alt></p>
<p>可知这次只install了resources-debug.apk 和 slice_0.apk。前者新增了我们加入的icon资源，后者新增了R$mipmap类中资源id字段。看到这里，你应该知道了，为什么不直接打成一个apk而是分出10个slice apk，因为大部分更改只需要redex和package单个slice apk，从而把redex的时间降低到原先的10%左右，达到真正的”Instant” Run。</p>
<p>完结，撒花🎉🎉🎉</p>
<p>参考：</p>
<ul>
<li><a href="https://android.googlesource.com/platform/tools/base/+/studio-master-dev/build-system/instant-run-instrumentation/README.md" target="_blank" rel="noopener">Instant Run Hot Swap</a></li>
<li><a href="https://android.googlesource.com/platform/tools/base/+/studio-master-dev/instant-run/" target="_blank" rel="noopener">Instant Run</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/15/dex文件结构/" rel="prev" title="dex文件结构">
                dex文件结构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/16531906?s=460&v=4" alt="bboylin">
          <p class="site-author-name" itemprop="name">bboylin</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/bboylin" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:bboylin24@gmail.com" target="_blank" title="email">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      email
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/5297849126" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/bboylin" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-user-md"></i>
                  
                    
                      zhihu
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.wanandroid.com" title="玩Android" target="_blank">玩Android</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OverView"><span class="nav-number">2.</span> <span class="nav-text">OverView</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析"><span class="nav-number">3.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hot-Swap"><span class="nav-number">3.1.</span> <span class="nav-text">Hot Swap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Warm-Swap"><span class="nav-number">3.2.</span> <span class="nav-text">Warm Swap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cold-Swap"><span class="nav-number">3.3.</span> <span class="nav-text">Cold Swap</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bboylin</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://bboylin.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://bboylin.github.io/2019/03/15/InstantRun源码分析/';
          this.page.identifier = '2019/03/15/InstantRun源码分析/';
          this.page.title = 'InstantRun原理以及源码分析';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://bboylin.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  








  





  

  

  

  

  

  

</body>
</html>
